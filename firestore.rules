rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      // Doctors (authenticated users) have full read/write access to patient data.
      allow read, write: if request.auth != null;

      // Patients (unauthenticated) can get their own document to view the dashboard
      // and update it to add records. This is secure because they must possess the
      // unique, unguessable patientId.
      allow get, update: if request.auth == null;

      // This is the critical fix for the chat subcollection.
      // This rule explicitly allows anyone to LIST the chat collection and CREATE messages.
      // 'list' is required for the onSnapshot listener.
      // 'create' is required for sending messages.
      match /chat/{messageId} {
        allow list, create: if true;

        // This rule allows doctors to read/write individual messages if ever needed,
        // maintaining full access for authenticated users.
        allow read, write: if request.auth != null;
      }
    }
  }
}
