rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      // Doctors can read/write all patient documents and their subcollections.
      allow read, write: if request.auth != null;

      // Patients (unauthenticated) can get their own data and update it.
      // This is safe because they must know the unguessable patientId.
      allow get, update: if request.auth == null;

      // This is the critical fix for the chat feature.
      // This rule block grants permissions for the 'chat' subcollection.
      match /chat/{messageId} {
        // Anyone (unauthenticated patients, authenticated doctors) can read
        // and create messages. This is required for the real-time chat listener
        // and for sending messages to work correctly.
        allow read, create: if true;
      }
    }
  }
}
