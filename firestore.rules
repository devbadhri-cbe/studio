
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Doctors collection
    match /doctors/{doctor} {
      // Anyone can create a doctor account (sign-up)
      allow create: if true;
      // Only the authenticated doctor can read or update their own document
      allow read, update: if request.auth.uid == doctor;
    }
    
    // Patients collection
    match /patients/{patientId} {
      // Doctors can create patients
      allow create: if request.auth != null;
      
      // Allow read access for the assigned doctor
      // and for any user (for patient dashboard access via direct URL)
      allow get: if request.auth.uid == resource.data.doctorId || request.auth == null;

      // Allow a doctor to list the patients that belong to them.
      allow list: if request.auth.uid == request.query.where.doctorId;
      
      // Allow updates only by the assigned doctor OR for anyone to update ONLY the lastLogin field
      allow update: if request.auth.uid == resource.data.doctorId || 
                      (request.auth == null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLogin']));
      
      // Allow deletes only by the assigned doctor
      allow delete: if request.auth.uid == resource.data.doctorId;
    }
  }
}
