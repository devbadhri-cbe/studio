rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      // Doctors (authenticated users) have full access to patient data.
      allow read, write: if request.auth != null;
      
      // Patients (unauthenticated) can get their own document to view the dashboard
      // and update it to add records or change their profile. This is secure because
      // they must know the unique and unguessable patientId.
      allow get, update: if request.auth == null;

      // Rules for the chat subcollection.
      match /chat/{messageId} {
        // Allow anyone (doctor or patient with the link) to list messages
        // (for the real-time listener) and create new messages. This is the
        // key change that resolves the permission error.
        allow list, create: if true;
        
        // Also explicitly allow doctors to read/write individual messages,
        // which is covered by the `allow read, write` on the parent, but
        // is good to have for clarity.
        allow read, write: if request.auth != null;
      }
    }
  }
}
