rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      
      // Doctors can read and write everything.
      allow read, write: if request.auth != null;

      // Patients (unauthenticated) can get their own document (to view the dashboard)
      // and update it (to add records). This is secure because they must know
      // the unguessable patientId.
      allow get, update: if request.auth == null;

      // This is the critical block for the chat subcollection.
      match /chat/{messageId} {
        // Allow reading (which includes list for the listener) and creating messages
        // ONLY IF the requestor would have permission to get the parent patient document.
        // This securely links the subcollection access to the parent document access.
        // Since unauthenticated patients have `get` access above, this rule will now pass.
        allow read, create: if exists(/databases/$(database)/documents/patients/$(patientId));
      }
    }
  }
}
