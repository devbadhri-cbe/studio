
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      // Authenticated doctors can read and write all patient data.
      allow read, write: if request.auth != null;

      // Unauthenticated patients can read their own document (which is
      // required to then access the chat subcollection) and update it
      // (to add records). This is secure as it requires the unguessable patient ID.
      allow read, update: if request.auth == null;

      // Rules for the chat subcollection.
      match /chat/{messageId} {
        // Since the parent read rule is now correct, this rule will allow
        // anyone who can read the patient document to also read and write
        // to the chat. This enables real-time listeners for unauthenticated
        // patients and allows both parties to send messages.
        allow read, write: if true;
      }
    }
  }
}
