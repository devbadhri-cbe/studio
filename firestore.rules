rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId} {
      // Doctors (authenticated) can list and create patients
      allow list, create: if request.auth != null;

      // Unauthenticated patients can get/update their own doc.
      // Authenticated doctors can get/update/delete any doc.
      allow get, update: if request.auth == null || request.auth != null;
      allow delete: if request.auth != null;

      match /chat/{messageId} {
        // Allow both authenticated doctors and unauthenticated patients
        // to read and write messages. This is safe because access to the
        // patientId is required to access the subcollection.
        allow read, write: if true;
      }
    }
  }
}
