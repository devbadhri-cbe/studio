
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthOwner() {
      return request.auth != null;
    }
    
    // Anyone can read a patient document if they know the ID.
    // This is used for patient login to verify the ID exists.
    function isPatientTryingToReadOwnDoc() {
        return request.method == 'get';
    }

    match /patients/{patientId} {
        // - Allow read access if the user is authenticated (a doctor).
        // - Allow read access for unauthenticated users if they are just fetching the document (for patient login).
        allow read: if isAuthOwner() || isPatientTryingToReadOwnDoc();

        // - Allow write access (create, update, delete) if the user is authenticated (a doctor).
        // - Allow patients to update their own document.
        allow write: if isAuthOwner() || request.resource.id == patientId;
    }
  }
}
